# π0.5

This page describes how to use model-opt to export, compute, and infer the `pi05 model`.

## More information about openpi usage: [openpi link](https://github.com/Physical-Intelligence/openpi)

### 1. prepare

#### 1.1  replace transforms with `openpi transformers`

```shell
cp -r ${YOUR_OPENPI_CODEPATH}/src/openpi/models_pytorch/transformers_replace/* /opt/openpi/lib/python3.12/site-packages/transformers/
```

#### 1.2 Get pi05 `pytorch` model from jax model.
[How to export pi05 model to pytorch detail page link](https://github.com/Physical-Intelligence/openpi?tab=readme-ov-file#pytorch-support)


### 2. Run pi05 pytorch model

```shell
python scripts/deployment/pi05/standalone_inference_script.py --model_path /srcs/sources/opensrc/robot/openpi/pytorch_pi05_libero/ --inference-mode pytorch --perf
```

+ output:
```shell
Inference time: 0.5023 seconds
e2e 494.89 ± 6.61 ms (shared)
```

### 3. Model export to onnx

##### We can use model-opt to export the PI05 model as three onnx models: vit, llm, and action expert.

#### 3.1 vit onnx model export

```shell
model-opt export --model_name pi05_libero/vit --model_path /srcs/sources/opensrc/robot/openpi/pytorch_pi05_libero/ --export_dir /tmp/export/pi05
```

+ `/srcs/sources/opensrc/robot/openpi/pytorch_pi05_libero/` is your pi05 pytorch model path get from `1.2`.


##### output:

```shell
pi05 model name: pi05_libero
Start Pi05Model load...
...
Pi05Model load done.
Start Vit export onnx...
Vit export onnx done to /tmp/export/pi05 cost:4.453001499176025s
```

### 4. Eval model

#### 4.1 convert dataset format.

```shell
python -m lerobot.datasets.v21.convert_dataset_v20_to_v21 --repo-id=physical-intelligence/libero
```

#### 4.2 compute norm stats
```shell
python /srcs/sources/opensrc/robot/openpi/scripts/compute_norm_stats.py --config-name=pi05_libero
```

#### 4.3 run eval

```shell
model-opt eval --model_name pi05_libero --model_path /srcs/sources/opensrc/robot/openpi/pytorch_pi05_libero/ --dataset pi05_libero --output_dir /tmp/eval/pi05/
```

## Q and A

#### Q: download `gs://big_vision/paligemma_tokenizer.model` failed. 

```shell
  File "/opt/openpi/lib/python3.12/site-packages/gcsfs/retry.py", line 113, in validate_response
    raise HttpError(error)
gcsfs.retry.HttpError: Anonymous caller does not have storage.objects.get access to the Google Cloud Storage object. Permission 'storage.objects.get' denied on resource (or it may not exist)., 401

```

#### A: use http_proxy or copy it from another place

```shell
cp -rf /srcs/.cache/openpi/big_vision/* /root/.cache/openpi/big_vision/
```